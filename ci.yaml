only:
    branch: master
#
steps:
    - name: build
      image: golang:1.25.6
      commands:
          - go mod tidy
          - go build -v ./...

    - name: docker
      image: docker:27
      commands:
          - docker build -t info_go .

    - name: deploy
      image: docker:27
      commands:
          - |
              echo "ğŸš€ Deploying new container..."

              # ğŸ”¹ 1. Sauvegarde de l'ancien conteneur s'il existe
              if [ "$(docker ps -q -f name=info_go_container)" ]; then
                echo "ğŸ“¦ Sauvegarde de l'ancien conteneur..."
                docker stop info_go_container || true
                docker rm -f info_go_backup || true
                docker rename info_go_container info_go_backup || true
              else
                echo "â„¹ï¸ Aucun conteneur existant Ã  sauvegarder."
              fi

              # ğŸ”¹ 2. DÃ©ploie la nouvelle version
              docker run -d \
                --name info_go_container \
                -p 127.0.0.1:8091:8091 \
                --env PORT=8091 \
                --env "ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-*}" \
                --env "ENVIRONMENT=${ENVIRONMENT:-production}" \
                info_go || exit 1

              # ğŸ”¹ 3. VÃ©rifie si le nouveau conteneur tourne bien
              echo "ğŸ” VÃ©rification du nouveau conteneur..."
              sleep 5
              if [ "$(docker ps -q -f name=info_go_container)" ]; then
                echo "âœ… Nouveau conteneur opÃ©rationnel."
                docker rm -f info_go_backup || true
              else
                echo "âŒ Nouveau conteneur dÃ©faillant, rollback..."
                echo "ğŸ“œ Logs du conteneur en erreur :"
                docker logs info_go_container || echo "âš ï¸ Aucun log dispo"
                docker rm -f info_go_container || true
                if [ "$(docker ps -aq -f name=info_go_backup)" ]; then
                  docker rename info_go_backup info_go_container || true
                  docker start info_go_container || true
                  echo "ğŸ” Rollback terminÃ©."
                else
                  echo "âš ï¸ Aucun backup disponible pour rollback."
                fi
                exit 1
              fi

              echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s"
